<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">

<head>
    <meta charset="UTF-8">
    <title th:text="${quizzes[0].quizTitle} + ' - Print Report'">Quiz Print Report</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans:wght@400;500;700&display=swap"
        rel="stylesheet">

    <style>
        /* ===== BASE SETTINGS ===== */
        @page {
            size: A4;
            margin: 1.27cm;
        }

        body {
            font-family: 'Noto Sans JP', 'Noto Sans', sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #000;
            background: #fff;
            -webkit-print-color-adjust: exact;
        }

        /* ===== EDIT MODE STYLES ===== */
        .edit-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .edit-controls button {
            margin-left: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        #editToggle {
            background: #007bff;
            color: white;
        }

        #editToggle:hover {
            background: #0056b3;
        }

        #saveEdits {
            background: #28a745;
            color: white;
        }

        #saveEdits:hover {
            background: #218838;
        }

        .edit-mode .editable-field {
            border: 1px dashed #007bff !important;
            padding: 2px 4px;
            background-color: #f0f8ff;
            cursor: text;
            min-height: 1.2em;
            display: inline-block;
            min-width: 50px;
        }

        .edit-mode .editable-field:hover {
            background-color: #e0f0ff;
        }

        .edit-mode .editable-field:focus {
            outline: 2px solid #007bff;
            background-color: #fff;
        }

        .edit-mode .option-checkbox {
            display: inline-block !important;
            margin-right: 4px;
            cursor: pointer;
        }

        .option-checkbox {
            display: none;
        }

        /* Hide edit controls during print */
        @media print {
            .edit-controls {
                display: none !important;
            }
            .edit-mode .editable-field {
                border: none !important;
                background: transparent !important;
                padding: 0;
            }
            .option-checkbox {
                display: none !important;
            }
        }

        /* ===== UTILITIES ===== */
        .page-break {
            page-break-before: always;
        }

        .no-break {
            page-break-inside: avoid;
        }

        /* ===== STUDENT HEADER ===== */
        .student-header {
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 11pt;
        }

        /* ===== QUESTION LAYOUT ===== */
        table.question-row {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            page-break-inside: avoid;
        }

        td.q-content {
            vertical-align: top;
            padding: 0;
        }

        /* ===== STATUS ICONS & NUMBERING ===== */
        .q-meta {
            font-weight: 700;
            margin-right: 5px;
            white-space: nowrap;
        }

        .status-correct {
            color: #000;
        }

        .status-incorrect {
            color: #000;
        }

        .status-unanswered {
            font-size: 11pt;
        }

        /* Triangle */

        /* ===== OPTIONS GRID ===== */
        .options-container {
            margin-top: 4px;
            margin-left: 15px;
            display: block;
        }

        .option-item {
            display: inline-block;
            width: 48%;
            vertical-align: top;
            margin-bottom: 2px;
        }

        /* CHECKBOX (Visual) */
        .box {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            margin-right: 4px;
            vertical-align: middle;
            position: relative;
        }

        .box.picked {
            background-color: #000;
        }

        /* TEXT DECORATION LOGIC */
        .opt-text {
            vertical-align: middle;
        }

        /* Strikethrough if WRONG */
        .picked-wrong .opt-text {
            text-decoration: line-through;
        }

        /* Checkmark if CORRECT option */
        .is-correct-option .opt-text::after {
            content: ' ‚úì';
            font-weight: bold;
            margin-left: 4px;
        }

        /* OPTION COMMENT */
        .opt-comment {
            display: block;
            font-size: 8pt;
            font-style: italic;
            color: #444;
            margin-left: 20px;
            margin-top: 1px;
        }

        /* ===== FEEDBACK ===== */
        .feedback-box {
            font-size: 9pt;
            font-style: italic;
            background-color: #f0f0f0;
            padding: 2px 8px;
            margin-top: 4px;
            margin-left: 15px;
            border-left: 2px solid #666;
        }

        /* ===== REVIEW SECTION ===== */
        .review-header {
            font-size: 12pt;
            font-weight: 900;
            text-transform: uppercase;
            border-bottom: 2px solid #000;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .review-mode .box {
            background-color: transparent !important;
        }

        .review-mode .opt-text {
            text-decoration: none !important;
        }

        .review-mode .opt-text::after {
            content: '' !important;
        }
    </style>
</head>

<body>

    <!-- Edit Mode Controls (Hidden during print) -->
    <div class="edit-controls">
        <button id="editToggle" onclick="toggleEditMode()">üìù Edit Report</button>
        <button id="saveEdits" onclick="saveEdits()" style="display: none;">üíæ Save Changes</button>
    </div>

    <div th:each="quiz, quizStat : ${quizzes}">

        <div th:each="student, iter : ${quiz.students}" class="student-wrapper"
             th:classappend="${!iter.first} ? 'page-break' : ''"
             th:attr="data-student-index=${iter.index}">

            <div class="student-header">
                <span class="editable-field"
                      data-field="studentName"
                      th:attr="data-student-index=${iter.index}"
                      th:text="${student.studentName}">Name</span>
                <span class="editable-field"
                      data-field="studentId"
                      th:attr="data-student-index=${iter.index}"
                      th:text="${student.studentId}">ID</span>
                <span th:text="${quiz.quizId}">Quiz</span>
            </div>

            <div th:each="question, qStat : ${student.questions}" class="question-wrapper"
                 th:attr="data-question-index=${qStat.index}">
                <table class="question-row no-break">
                    <tr>
                        <td class="q-content">
                            <div style="margin-bottom: 4px;">
                                <span class="q-meta">
                                    <span th:if="${question.answerStatus.name() == 'CORRECT'}"
                                        class="status-correct">‚úì</span>
                                    <span th:if="${question.answerStatus.name() == 'INCORRECT'}"
                                        class="status-incorrect">‚úó</span>
                                    <span th:if="${question.answerStatus.name() == 'UNANSWERED'}"
                                        class="status-unanswered">‚ñ≤</span>
                                    <span th:text="${question.questionNumber} + '.'">1.</span>
                                </span>
                                <span class="editable-field"
                                      data-field="questionText"
                                      th:attr="data-question-index=${qStat.index}"
                                      th:utext="${question.questionText}">Question Text...</span>
                            </div>

                            <div th:if="${question.hasOptions}" class="options-container">
                                <div th:each="option, optStat : ${question.options}" class="option-item"
                                    th:classappend="${(option.studentAnswer and !option.correct ? 'picked-wrong ' : '') + (option.correct ? 'is-correct-option' : '')}">

                                    <!-- Hidden checkbox for edit mode -->
                                    <input type="checkbox"
                                           class="option-checkbox"
                                           th:attr="data-question-index=${qStat.index},data-option-index=${optStat.index}"
                                           th:checked="${option.studentAnswer}">

                                    <span class="box" th:classappend="${option.studentAnswer} ? 'picked' : ''"></span>
                                    <span class="opt-letter" th:text="${option.optionLetter} + '.'">A.</span>
                                    <span class="opt-text editable-field"
                                          data-field="optionText"
                                          th:attr="data-option-index=${optStat.index}"
                                          th:text="${option.optionText}">Option</span>
                                    <span
                                        th:if="${option.commentText != null and !#strings.isEmpty(option.commentText)}"
                                        class="opt-comment editable-field"
                                        data-field="optionComment"
                                        th:attr="data-option-index=${optStat.index}"
                                        th:text="${option.commentText}">Comment</span>
                                </div>
                            </div>

                            <div th:unless="${question.hasOptions}" style="margin: 4px 15px; font-weight: bold;">
                                Your Answer: <span class="editable-field"
                                                   data-field="studentAnswerText"
                                                   th:attr="data-question-index=${qStat.index}"
                                                   th:text="${question.studentAnswerText}">Text</span>
                            </div>

                            <div th:if="${question.feedbackText != null and !#strings.isEmpty(question.feedbackText)}"
                                class="feedback-box">
                                Feedback: <span class="editable-field"
                                               data-field="feedbackText"
                                               th:attr="data-question-index=${qStat.index}"
                                               th:utext="${question.feedbackText}"></span>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div th:if="${!student.incorrectQuestionNumbers.isEmpty()}">
                <div class="page-break"></div>

                <div class="review-header">
                    Review Required (<span th:each="num, iter : ${student.incorrectQuestionNumbers}"
                        th:text="${num} + (${iter.last} ? '' : ', ')"></span>)
                </div>

                <div th:each="question : ${student.questions}" th:if="${question.answerStatus.name() != 'CORRECT'}"
                    class="review-mode">

                    <table class="question-row no-break">
                        <tr>
                            <td class="q-content">
                                <div style="margin-bottom: 4px;">
                                    <span class="q-meta" th:text="${question.questionNumber} + '.'">1.</span>
                                    <span th:utext="${question.questionText}">Text</span>
                                </div>

                                <div th:if="${question.hasOptions}" class="options-container">
                                    <div th:each="option : ${question.options}" class="option-item">
                                        <span class="box"></span>
                                        <span class="opt-letter" th:text="${option.optionLetter} + '.'">A.</span>
                                        <span class="opt-text" th:text="${option.optionText}">Option</span>
                                    </div>
                                </div>

                                <div th:unless="${question.hasOptions}"
                                    style="height: 30px; border-bottom: 1px dashed #ccc; margin: 10px 15px;"></div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script th:src="@{/js/print-report-editor.js}"></script>
</body>

</html>