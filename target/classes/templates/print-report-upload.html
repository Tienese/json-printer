<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${reportTitle} ?: 'Generate Print Report'">Generate Print Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/bw-landing.css}">
</head>
<body>

<div class="main-container">
    <div class="page-header">
        <h1><span class="icon">▪</span> <span th:text="${reportTitle} ?: 'Print Report Generator'">Print Report Generator</span></h1>
        <p>Generate printable student reports from Canvas LMS</p>
    </div>

    <!-- Navigation -->
    <div class="mb-20">
        <a href="/dashboard" class="btn btn-secondary">&larr; Back to Dashboard</a>
    </div>

    <!-- Quiz Title Display -->
    <div th:if="${quizTitle}" class="alert alert-info mb-20">
        <strong>Selected Quiz:</strong> <span th:text="${quizTitle}"></span>
    </div>

    <!-- Error Message -->
    <div th:if="${error}" class="alert alert-error mb-20" role="alert" th:text="${error}"></div>

    <!-- Upload Form -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Generate Print Report</h5>
        </div>
        <div class="card-body">
            <form id="generateForm" method="post" action="/print-report/generate" enctype="multipart/form-data">

                <div class="form-row">
                    <div class="form-group">
                        <label for="courseId">Canvas Course ID</label>
                        <input type="text"
                               id="courseId"
                               name="courseId"
                               th:value="${prefilledCourseId}"
                               placeholder="e.g., 12345"
                               required>
                        <small class="text-muted">
                            Find this in your Canvas course URL
                            <span th:if="${prefilledCourseId}" class="text-success">✓ Pre-filled from dashboard</span>
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="quizId">Canvas Quiz ID</label>
                        <input type="text"
                               id="quizId"
                               name="quizId"
                               th:value="${prefilledQuizId}"
                               placeholder="e.g., 67890"
                               required>
                        <small class="text-muted">
                            Find this in your Canvas quiz URL
                            <span th:if="${prefilledQuizId}" class="text-success">✓ Pre-filled from dashboard</span>
                        </small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="csvFile">Student Responses CSV</label>
                    <input type="file"
                           id="csvFile"
                           name="csvFile"
                           accept=".csv"
                           required>
                    <small class="text-muted">
                        Export this from Canvas: Quiz → Student Analysis → Download All Student Responses
                    </small>
                </div>

                <div class="form-group">
                    <label>Report Style</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio"
                                   name="reportType"
                                   id="reportTypeSlip"
                                   value="slip"
                                   th:checked="${reportType == 'slip'}">
                            <strong>□ Retake Slip (Recommended)</strong>
                            <small class="text-muted">Prints only incorrect/unanswered questions. Compact format (~1 page/student).</small>
                        </label>
                        <label class="radio-option">
                            <input type="radio"
                                   name="reportType"
                                   id="reportTypeFull"
                                   value="full"
                                   th:checked="${reportType == 'full'}">
                            <strong>▪ Full Print Report</strong>
                            <small class="text-muted">Prints all questions with answers and feedback (~3-5 pages/student).</small>
                        </label>
                    </div>
                </div>

                <div class="alert alert-info">
                    <h6><strong>Instructions:</strong></h6>
                    <ol>
                        <li>Go to your Canvas quiz</li>
                        <li>Click "Student Analysis"</li>
                        <li>Click "Download All Student Responses" to get the CSV</li>
                        <li>Enter the Course ID and Quiz ID from your Canvas URL</li>
                        <li>Upload the CSV file and click Generate</li>
                    </ol>
                </div>

                <div class="text-center mt-20">
                    <button type="submit" id="submitBtn" class="btn btn-primary btn-lg">
                        <span class="btn-icon">▶</span> Generate Report
                    </button>
                </div>

            </form>
        </div>

        <!-- Loading Overlay (Hidden by default) -->
        <div id="loadingOverlay" style="display: none; text-align: center; padding: 20px;">
            <div class="spinner"></div>
            <p><strong>Generating Report...</strong></p>
            <p class="text-muted">Fetching data from Canvas and parsing CSV.<br>This may take a few seconds.</p>
        </div>

        <script>
            document.getElementById('generateForm').addEventListener('submit', function(e) {
                var btn = document.getElementById('submitBtn');
                var overlay = document.getElementById('loadingOverlay');
                var formBody = this.querySelector('.form-row').parentNode; // Get the form content container

                // Simple client-side validation for file
                var fileInput = document.getElementById('csvFile');
                if (fileInput.files.length > 0) {
                    var fileName = fileInput.files[0].name;
                    if (!fileName.toLowerCase().endsWith('.csv')) {
                        e.preventDefault();
                        alert('Please upload a valid CSV file.');
                        return;
                    }
                }

                // Show loading state
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner" style="width: 20px; height: 20px; border-width: 2px; display: inline-block; vertical-align: middle; margin-bottom: 0; margin-right: 10px;"></span> Generating...';

                // Optional: Hide form fields and show large spinner
                // formBody.style.opacity = '0.5';
                // formBody.style.pointerEvents = 'none';
            });
        </script>
        </div>
    </div>

    <div class="footer">
        <p>QTI Helper v2.0 | Canvas LMS Integration</p>
    </div>

</div>

</body>
</html>
