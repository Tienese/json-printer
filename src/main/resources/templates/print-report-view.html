<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">

<head>
    <meta charset="UTF-8">
    <title th:text="${quizzes[0].quizTitle} + ' - Print Report'">Quiz Print Report</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans:wght@400;500;700&display=swap"
        rel="stylesheet">

    <style>
        /* ===== BASE SETTINGS ===== */
        @page {
            size: A4;
            margin: 1.27cm;
        }

        body {
            font-family: 'Noto Sans JP', 'Noto Sans', sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #000;
            background: #fff;
            -webkit-print-color-adjust: exact;
        }

        /* ===== UTILITIES ===== */
        .page-break {
            page-break-before: always;
        }

        .no-break {
            page-break-inside: avoid;
        }

        /* ===== STUDENT HEADER ===== */
        .student-header {
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 11pt;
        }

        /* ===== QUESTION LAYOUT (Single Row) ===== */
        table.question-row {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12px;
            /* Increased slightly for separation */
            page-break-inside: avoid;
        }

        td.q-content {
            vertical-align: top;
            padding: 0;
        }

        /* ===== STATUS ICONS & NUMBERING ===== */
        .q-meta {
            font-weight: 700;
            margin-right: 5px;
            white-space: nowrap;
        }

        /* Specific Status Styles */
        .status-correct {
            color: #000;
        }

        .status-incorrect {
            color: #000;
        }

        .status-unanswered {
            font-size: 11pt;
        }

        /* Triangle */

        /* Points floating right */
        .q-points {
            float: right;
            font-size: 9pt;
            font-weight: normal;
            margin-left: 10px;
        }

        /* ===== OPTIONS GRID ===== */
        .options-container {
            margin-top: 4px;
            margin-left: 15px;
            /* Indent options slightly */
            display: block;
        }

        .option-item {
            display: inline-block;
            width: 48%;
            vertical-align: top;
            margin-bottom: 2px;
        }

        /* CHECKBOX (What the student picked) */
        .box {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            margin-right: 4px;
            vertical-align: middle;
            position: relative;
        }

        .box.picked {
            background-color: #000;
        }

        /* Filled if student picked */

        /* TEXT DECORATION LOGIC */
        .opt-text {
            vertical-align: middle;
        }

        /* 1. Student Picked WRONG -> Strikethrough */
        .picked-wrong .opt-text {
            text-decoration: line-through;
        }

        /* 2. Is Correct Option -> Checkmark at end (Always) */
        .is-correct-option .opt-text::after {
            content: ' ✓';
            font-weight: bold;
            margin-left: 4px;
        }

        /* ===== FEEDBACK ===== */
        .feedback-box {
            font-size: 9pt;
            font-style: italic;
            background-color: #f0f0f0;
            padding: 2px 8px;
            margin-top: 4px;
            margin-left: 15px;
            border-left: 2px solid #666;
        }

        /* ===== REVIEW SECTION (RETAKE) ===== */
        .review-header {
            font-size: 12pt;
            font-weight: 900;
            text-transform: uppercase;
            border-bottom: 2px solid #000;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        /* Clean slate for review */
        .review-mode .box {
            background-color: transparent !important;
        }

        .review-mode .opt-text {
            text-decoration: none !important;
        }

        .review-mode .opt-text::after {
            content: '' !important;
        }
    </style>
</head>

<body>

    <div th:each="quiz : ${quizzes}">
        <div th:each="student : ${quiz.students}" class="page-break">

            <div class="student-header">
                <span th:text="${student.studentName}">Name</span>
                <span th:text="${student.studentId}">ID</span>
                <span th:text="${quiz.quizTitle}">Quiz</span>
            </div>

            <div th:each="question : ${student.questions}">
                <table class="question-row no-break">
                    <tr>
                        <td class="q-content">
                            <div style="margin-bottom: 4px;">
                                <span class="q-points" th:text="${question.pointsPossible} + ' pts'">1.0 pts</span>

                                <span class="q-meta">
                                    <span th:if="${question.answerStatus.name() == 'CORRECT'}"
                                        class="status-correct">✓</span>
                                    <span th:if="${question.answerStatus.name() == 'INCORRECT'}"
                                        class="status-incorrect">✗</span>
                                    <span th:if="${question.answerStatus.name() == 'UNANSWERED'}"
                                        class="status-unanswered">▲</span>

                                    <span th:text="${question.questionNumber} + '.'">1.</span>
                                </span>

                                <span th:utext="${question.questionText}">Question Text...</span>
                            </div>

                            <div th:if="${question.hasOptions}" class="options-container">
                                <div th:each="option : ${question.options}" class="option-item"
                                    th:classappend="${(option.studentAnswer and !option.correct ? 'picked-wrong ' : '') + (option.correct ? 'is-correct-option' : '')}">

                                    <span class="box" th:classappend="${option.studentAnswer} ? 'picked' : ''"></span>

                                    <span class="opt-letter" th:text="${option.optionLetter} + '.'">A.</span>
                                    <span class="opt-text" th:text="${option.optionText}">Option</span>
                                </div>
                            </div>

                            <div th:unless="${question.hasOptions}" style="margin: 4px 15px; font-weight: bold;">
                                Your Answer: <span th:text="${question.studentAnswerText}">Text</span>
                            </div>

                            <div th:if="${question.feedbackText != null and !#strings.isEmpty(question.feedbackText)}"
                                class="feedback-box">
                                Feedback: <span th:utext="${question.feedbackText}"></span>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div th:if="${!student.incorrectQuestionNumbers.isEmpty()}">
                <div class="page-break"></div>

                <div class="review-header">
                    Review Required (<span th:each="num, iter : ${student.incorrectQuestionNumbers}"
                        th:text="${num} + (${iter.last} ? '' : ', ')"></span>)
                </div>

                <div th:each="question : ${student.questions}" th:if="${question.answerStatus.name() != 'CORRECT'}"
                    class="review-mode">

                    <table class="question-row no-break">
                        <tr>
                            <td class="q-content">
                                <div style="margin-bottom: 4px;">
                                    <span class="q-meta" th:text="${question.questionNumber} + '.'">1.</span>
                                    <span th:utext="${question.questionText}">Text</span>
                                </div>

                                <div th:if="${question.hasOptions}" class="options-container">
                                    <div th:each="option : ${question.options}" class="option-item">
                                        <span class="box"></span> <span class="opt-letter"
                                            th:text="${option.optionLetter} + '.'">A.</span>
                                        <span class="opt-text" th:text="${option.optionText}">Option</span>
                                    </div>
                                </div>

                                <div th:unless="${question.hasOptions}"
                                    style="height: 30px; border-bottom: 1px dashed #ccc; margin: 10px 15px;"></div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

        </div>
    </div>

</body>

</html>